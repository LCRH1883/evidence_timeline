<adonis:AdonisWindow x:Class="evidence_timeline.MainWindow"
                     xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                     xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                     xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                     xmlns:models="clr-namespace:evidence_timeline.Models"
                     xmlns:adonis="clr-namespace:AdonisUI.Controls;assembly=AdonisUI"
                     xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
                     mc:Ignorable="d"
                     Title="Evidence Timeline"
                     Icon="/assets/intagri icon.png"
                     Height="600"
                     Width="1000"
                     MinHeight="500"
                     MinWidth="800"
                     Loaded="OnLoaded">
    <Window.Resources>
        <!-- Window-specific styles only -->
        <Style x:Key="ResizableColumnStyle" TargetType="ColumnDefinition">
            <Setter Property="Width" Value="220" />
            <Setter Property="MinWidth" Value="180" />
        </Style>
        <Style x:Key="ResizableRowStyle" TargetType="RowDefinition">
            <Setter Property="Height" Value="180" />
            <Setter Property="MinHeight" Value="100" />
        </Style>
    </Window.Resources>

    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_New Case" Command="{Binding CreateCaseCommand}" />
                <MenuItem Header="_Open Case" Command="{Binding OpenCaseCommand}" />
                <MenuItem Header="Open _Recent..." Click="OnOpenRecentClicked" />
                <MenuItem Header="_Save Case" Command="{Binding SaveCaseCommand}" />
                <Separator />
                <MenuItem Header="E_xit" IsEnabled="False" />
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Manage Links" Command="{Binding ManageLinksCommand}" IsEnabled="{Binding SelectedEvidenceDetail}" />
                <MenuItem Header="Undo (N/A)" IsEnabled="False" />
            </MenuItem>
            <MenuItem Header="_Data">
                <MenuItem Header="_Types">
                    <MenuItem Header="_Add Type" Command="{Binding AddTypeCommand}" />
                    <MenuItem Header="_Rename Type" Command="{Binding RenameTypeCommand}" />
                    <MenuItem Header="_Delete Type" Command="{Binding DeleteTypeCommand}" />
                </MenuItem>
                <MenuItem Header="_People">
                    <MenuItem Header="_Add Person" Command="{Binding AddPersonCommand}" />
                    <MenuItem Header="_Rename Person" Command="{Binding RenamePersonCommand}" />
                    <MenuItem Header="_Delete Person" Command="{Binding DeletePersonCommand}" />
                    <Separator />
                    <MenuItem Header="_Manage People..." Command="{Binding ManagePeopleCommand}" />
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="Show Metadata Pane" IsCheckable="True" IsChecked="{Binding IsRightPaneVisible, Mode=TwoWay}" />
                <MenuItem Header="Show Notes Pane" IsCheckable="True" IsChecked="{Binding IsBottomPaneVisible, Mode=TwoWay}" />
                <Separator />
                <MenuItem Header="Sort Newest First" IsCheckable="True" IsChecked="{Binding SortNewestFirst, Mode=TwoWay}" />
                <Separator />
                <MenuItem Header="_Zoom">
                    <MenuItem Header="50%" Command="{Binding SetZoomCommand}" CommandParameter="0.5" />
                    <MenuItem Header="75%" Command="{Binding SetZoomCommand}" CommandParameter="0.75" />
                    <MenuItem Header="100% (Default)" Command="{Binding SetZoomCommand}" CommandParameter="1.0" />
                    <MenuItem Header="125%" Command="{Binding SetZoomCommand}" CommandParameter="1.25" />
                    <MenuItem Header="150%" Command="{Binding SetZoomCommand}" CommandParameter="1.5" />
                    <MenuItem Header="175%" Command="{Binding SetZoomCommand}" CommandParameter="1.75" />
                    <MenuItem Header="200%" Command="{Binding SetZoomCommand}" CommandParameter="2.0" />
                </MenuItem>
                <MenuItem Header="Editor _Font Size">
                    <MenuItem Header="6 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="6" />
                    <MenuItem Header="7 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="7" />
                    <MenuItem Header="8 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="8" />
                    <MenuItem Header="9 pt (Default)" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="9" />
                    <MenuItem Header="10 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="10" />
                    <MenuItem Header="11 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="11" />
                    <MenuItem Header="12 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="12" />
                    <MenuItem Header="13 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="13" />
                    <MenuItem Header="14 pt" Command="{Binding SetEditorFontSizeCommand}" CommandParameter="14" />
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Settings">
                <MenuItem Header="_Preferences" Command="{Binding OpenPreferencesCommand}" />
                <MenuItem Header="Case _Settings" Command="{Binding OpenCaseSettingsCommand}" IsEnabled="{Binding CurrentCase}" />
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Check for Updates..." Click="OnCheckForUpdatesClicked" />
                <MenuItem Header="_View Changelog..." Click="OnViewChangelogClicked" />
                <Separator />
                <MenuItem Header="_About Evidence Timeline" Click="OnAboutClicked" />
            </MenuItem>
        </Menu>

        <!-- Bottom status bar -->
        <Border DockPanel.Dock="Bottom"
                Background="{DynamicResource BackgroundLight}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0 1 0 0"
                Padding="8 4">
            <DockPanel>
                <TextBlock DockPanel.Dock="Left"
                           VerticalAlignment="Center"
                           FontSize="11">
                    <Run Text="Evidence Count: " />
                    <Run Text="{Binding EvidenceList.Count, Mode=OneWay, FallbackValue=0}" FontWeight="SemiBold" />
                </TextBlock>

                <TextBlock DockPanel.Dock="Right"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Margin="12 0 0 0">
                    <Run Text="Selected: " />
                    <Run Text="{Binding SelectedSummary.EvidenceNumber, Mode=OneWay, FallbackValue='-'}" FontWeight="SemiBold" />
                </TextBlock>

                <TextBlock DockPanel.Dock="Right"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Margin="12 0 0 0"
                           Text="{Binding CurrentCase.FilePath, Mode=OneWay, FallbackValue='No case loaded'}" />
            </DockPanel>
        </Border>

        <!-- Main content grid -->
        <Grid>
            <Grid.LayoutTransform>
                <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}" />
            </Grid.LayoutTransform>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition>
                    <RowDefinition.Style>
                        <Style TargetType="RowDefinition">
                            <Setter Property="Height" Value="5" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsBottomPaneVisible}" Value="False">
                                    <Setter Property="Height" Value="0" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </RowDefinition.Style>
                </RowDefinition>
                <RowDefinition>
                    <RowDefinition.Style>
                        <Style TargetType="RowDefinition" BasedOn="{StaticResource ResizableRowStyle}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsBottomPaneVisible}" Value="False">
                                    <Setter Property="Height" Value="0" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </RowDefinition.Style>
                </RowDefinition>
            </Grid.RowDefinitions>

            <!-- Main area with filters and content -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="5">
                        <ColumnDefinition.Style>
                            <Style TargetType="ColumnDefinition">
                                <Setter Property="Width" Value="5" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRightPaneVisible}" Value="False">
                                        <Setter Property="Width" Value="0" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ColumnDefinition.Style>
                    </ColumnDefinition>
                    <ColumnDefinition x:Name="InnerRightColumn">
                        <ColumnDefinition.Style>
                            <Style TargetType="ColumnDefinition" BasedOn="{StaticResource ResizableColumnStyle}">
                                <Setter Property="Width" Value="320" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRightPaneVisible}" Value="False">
                                        <Setter Property="Width" Value="0" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ColumnDefinition.Style>
                    </ColumnDefinition>
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!-- Case name header -->
                    <TextBlock Text="{Binding CurrentCase.Name, TargetNullValue='No case loaded'}"
                               FontSize="10"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Margin="4 2 4 2" />

                    <!-- Compact filter bar -->
                    <Border Grid.Row="1"
                            Background="{DynamicResource BackgroundLight}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0 1"
                            Padding="4 2">
                        <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <!-- Search -->
                            <TextBlock Text="Search:"
                                       VerticalAlignment="Center"
                                       Margin="0 0 4 0"
                                       FontWeight="SemiBold" />
                            <TextBox Width="180"
                                     Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     VerticalContentAlignment="Center"
                                     Margin="0 0 12 0"
                                     ToolTip="Search evidence" />

                            <!-- Type filter -->
                            <TextBlock Text="Type:"
                                       VerticalAlignment="Center"
                                       Margin="0 0 4 0"
                                       FontWeight="SemiBold" />
                            <ComboBox Width="140"
                                      ItemsSource="{Binding EvidenceTypes}"
                                      DisplayMemberPath="Name"
                                      SelectedItem="{Binding SelectedType}"
                                      Margin="0 0 12 0"
                                      ToolTip="Filter by type" />

                            <!-- Person filter -->
                            <TextBlock Text="Person:"
                                       VerticalAlignment="Center"
                                       Margin="0 0 4 0"
                                       FontWeight="SemiBold" />
                            <ComboBox Width="140"
                                      ItemsSource="{Binding People}"
                                      DisplayMemberPath="Name"
                                      SelectedItem="{Binding SelectedPerson}"
                                      Margin="0 0 12 0"
                                      ToolTip="Filter by person" />

                            <!-- Clear filters button -->
                            <Button Content="Clear"
                                    Command="{Binding ClearFiltersCommand}"
                                    Padding="10 3"
                                    Margin="0 0 12 0"
                                    ToolTip="Clear all filters" />

                            <!-- Separator -->
                            <Border Width="1"
                                    Height="24"
                                    Background="{DynamicResource BorderBrush}"
                                    Margin="0 0 12 0" />

                            <!-- Action buttons -->
                            <Button Style="{StaticResource IconButton}"
                                    Command="{Binding NewEvidenceCommand}"
                                    ToolTip="New Evidence"
                                    Margin="0 0 6 0">
                                <iconPacks:PackIconMaterial Kind="PlusBoxMultipleOutline"
                                                            Width="14"
                                                            Height="14"
                                                            Foreground="{DynamicResource IconForeground}" />
                            </Button>
                            <Button Style="{StaticResource IconButton}"
                                    Command="{Binding OpenEvidenceWindowCommand}"
                                    ToolTip="Open Evidence">
                                <iconPacks:PackIconMaterial Kind="FolderOpenOutline"
                                                            Width="14"
                                                            Height="14"
                                                            Foreground="{DynamicResource IconForeground}" />
                            </Button>
                            <Button Style="{StaticResource IconButton}"
                                    Command="{Binding DeleteEvidenceCommand}"
                                    ToolTip="Delete Evidence"
                                    Margin="6 0 0 0">
                                <iconPacks:PackIconMaterial Kind="DeleteForeverOutline"
                                                            Width="14"
                                                            Height="14"
                                                            Foreground="{DynamicResource IconForeground}" />
                            </Button>
                        </WrapPanel>
                    </Border>
                    <DataGrid Grid.Row="2"
                              ItemsSource="{Binding EvidenceList}"
                              SelectedItem="{Binding SelectedSummary, Mode=TwoWay}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Margin="8"
                              SelectionMode="Single"
                              MouseDoubleClick="OnEvidenceRowDoubleClick">
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Open" Command="{Binding OpenEvidenceWindowCommand}" />
                                <MenuItem Header="Delete" Command="{Binding DeleteEvidenceCommand}" />
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#"
                                                Width="60"
                                                Binding="{Binding EvidenceNumber}" />
                            <DataGridTextColumn Header="Title"
                                                Width="*"
                                                Binding="{Binding Title}" />
                            <DataGridTextColumn Header="Date"
                                                Width="140"
                                                Binding="{Binding DateDisplay}" />
                            <DataGridTextColumn Header="Type"
                                                Width="140"
                                                Binding="{Binding TypeName}" />
                            <DataGridTextColumn Header="Court #"
                                                Width="100"
                                                Binding="{Binding CourtNumber}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>

                <GridSplitter Grid.Column="1"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"
                              Background="{DynamicResource BorderBrush}"
                              ResizeDirection="Columns"
                              ResizeBehavior="PreviousAndNext"
                              ShowsPreview="True"
                              Visibility="{Binding IsRightPaneVisible, Converter={StaticResource BoolToVis}}" />

                <Border Grid.Column="2"
                        Background="{DynamicResource SurfaceBackground}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1 0 0 0"
                        Visibility="{Binding IsRightPaneVisible, Converter={StaticResource BoolToVis}}">
                    <DockPanel>
                        <!-- Compact header bar -->
                        <Border DockPanel.Dock="Top"
                                Background="{DynamicResource BackgroundLight}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0 0 0 1"
                                Padding="4 2">
                            <DockPanel VerticalAlignment="Center">
                                <TextBlock Text="Metadata"
                                           FontWeight="SemiBold"
                                           FontSize="9"
                                           VerticalAlignment="Center"
                                           DockPanel.Dock="Left"
                                           Margin="0" />
                                <StackPanel Orientation="Horizontal"
                                            DockPanel.Dock="Right"
                                            VerticalAlignment="Center">
                                    <TextBlock x:Name="MetadataSaveStatusText"
                                               Text="All changes saved"
                                               FontSize="8"
                                               Foreground="{DynamicResource TextSecondary}"
                                               VerticalAlignment="Center"
                                               Margin="4 0 4 0" />
                                    <Button Command="{Binding SaveMetadataCommand}"
                                            Style="{StaticResource IconButton}"
                                            ToolTip="Save metadata">
                                <iconPacks:PackIconMaterial Kind="ContentSaveOutline"
                                                            Width="14"
                                                            Height="14" />
                                    </Button>
                                </StackPanel>
                            </DockPanel>
                        </Border>

                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="4">
                            <TextBlock Text="Title" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding SelectedEvidenceDetail.Title, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0 0 0 3"
                                     KeyDown="OnMetadataEnterKey"
                                     LostFocus="OnMetadataFieldLostFocus" />
                            <TextBlock Text="Court #" Style="{StaticResource LabelText}" />
                            <TextBox Text="{Binding SelectedEvidenceDetail.CourtNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0 0 0 3"
                                     KeyDown="OnMetadataEnterKey"
                                     LostFocus="OnMetadataFieldLostFocus" />
                            <TextBlock Text="Type" Style="{StaticResource LabelText}" />
                            <ComboBox ItemsSource="{Binding EvidenceTypes}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      SelectedValue="{Binding SelectedEvidenceDetail.TypeId, Mode=TwoWay}"
                                      Margin="0 0 0 3"
                                      SelectionChanged="OnMetadataSelectionChanged" />
                            <TextBlock Text="Date mode" Style="{StaticResource LabelText}" />
                            <ComboBox SelectedValue="{Binding SelectedDateMode, Mode=TwoWay}"
                                      SelectedValuePath="Tag"
                                      Margin="0 0 0 3"
                                      SelectionChanged="OnMetadataSelectionChanged">
                                <ComboBoxItem Content="Exact" Tag="{x:Static models:EvidenceDateMode.Exact}" />
                                <ComboBoxItem Content="Around" Tag="{x:Static models:EvidenceDateMode.Around}" />
                                <ComboBoxItem Content="Broad" Tag="{x:Static models:EvidenceDateMode.Broad}" />
                            </ComboBox>
                            <TextBlock Text="Exact date" Style="{StaticResource LabelText}" />
                            <DatePicker SelectedDate="{Binding ExactDate, Mode=TwoWay}"
                                        Margin="0 0 0 3"
                                        SelectedDateChanged="OnMetadataSelectionChanged" />
                            <TextBlock Text="Start date" Style="{StaticResource LabelText}" />
                            <DatePicker SelectedDate="{Binding StartDate, Mode=TwoWay}"
                                        Margin="0 0 0 3"
                                        SelectedDateChanged="OnMetadataSelectionChanged" />
                            <TextBlock Text="End date" Style="{StaticResource LabelText}" />
                            <DatePicker SelectedDate="{Binding EndDate, Mode=TwoWay}"
                                        Margin="0 0 0 3"
                                        SelectedDateChanged="OnMetadataSelectionChanged" />
                            <TextBlock Text="Around amount/unit" Style="{StaticResource LabelText}" />
                            <StackPanel Orientation="Horizontal" Margin="0 0 0 3">
                                <TextBox Width="60"
                                         Text="{Binding AroundAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         KeyDown="OnMetadataEnterKey"
                                         LostFocus="OnMetadataFieldLostFocus" />
                                <ComboBox Width="120"
                                          SelectedValue="{Binding AroundUnit, Mode=TwoWay}"
                                          SelectionChanged="OnMetadataSelectionChanged"
                                          Margin="6 0 0 0">
                                    <ComboBoxItem Content="days" />
                                    <ComboBoxItem Content="weeks" />
                                    <ComboBoxItem Content="months" />
                                </ComboBox>
                            </StackPanel>
                            <TextBlock Text="People" Style="{StaticResource LabelText}" Margin="0 6 0 0" />
                            <ItemsControl ItemsSource="{Binding PersonOptions}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding Name}"
                                                  IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                  Checked="OnMetadataCheckboxChanged"
                                                  Unchecked="OnMetadataCheckboxChanged" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <StackPanel Orientation="Horizontal" Margin="0 6 0 6">
                                <Button Content="Select links"
                                        Command="{Binding ManageLinksCommand}"
                                        Margin="0 0 6 0" />
                                <TextBlock Text="Linked IDs (manual):"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <TextBox Text="{Binding LinkedEvidenceText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto"
                                     Height="60" />
                            <TextBlock Text="Attachments" Style="{StaticResource LabelText}" Margin="0 6 0 4" />
                            <StackPanel AllowDrop="True"
                                        Background="Transparent"
                                        DragOver="OnAttachmentsDragOver"
                                        Drop="OnAttachmentsDrop">
                                <ItemsControl ItemsSource="{Binding SelectedEvidenceDetail.Attachments}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding FileName}" Width="150" />
                                                <Button Style="{StaticResource IconButton}"
                                                        Margin="4 0 0 0"
                                                        ToolTip="Open attachment"
                                                        Command="{Binding DataContext.OpenAttachmentCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}">
                                                    <iconPacks:PackIconBootstrapIcons Kind="BoxArrowUpRight"
                                                                                      Width="14"
                                                                                      Height="14" />
                                                </Button>
                                                <Button Style="{StaticResource IconButton}"
                                                        Margin="4 0 0 0"
                                                        ToolTip="Show in folder"
                                                        Command="{Binding DataContext.OpenAttachmentFolderCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}">
                                                    <iconPacks:PackIconBootstrapIcons Kind="Folder2Open"
                                                                                      Width="14"
                                                                                      Height="14" />
                                                </Button>
                                                <Button Style="{StaticResource IconButton}"
                                                        Margin="4 0 0 0"
                                                        ToolTip="Remove attachment"
                                                        Command="{Binding DataContext.RemoveAttachmentCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}">
                                                    <iconPacks:PackIconBootstrapIcons Kind="Trash"
                                                                                      Width="14"
                                                                                      Height="14" />
                                                </Button>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <Button Content="Add attachment"
                                        Command="{Binding AddAttachmentCommand}"
                                        Margin="0 6 0 0" />
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
            </Grid>

            <!-- Horizontal splitter for notes -->
            <GridSplitter Grid.Row="1"
                          Grid.ColumnSpan="3"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Background="{DynamicResource BorderBrush}"
                          ResizeDirection="Rows"
                          ResizeBehavior="PreviousAndNext"
                          ShowsPreview="True"
                          Visibility="{Binding IsBottomPaneVisible, Converter={StaticResource BoolToVis}}" />

            <!-- Bottom pane with tabs spanning center/right -->
            <Border Grid.Row="2"
                    Grid.ColumnSpan="3"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0 1 0 0"
                    Visibility="{Binding IsBottomPaneVisible, Converter={StaticResource BoolToVis}}">
                <TabControl Margin="0">
                    <!-- Notes Tab -->
                    <TabItem Header="Notes">
                        <DockPanel>
                            <!-- Compact header bar with formatting toolbar -->
                            <Border DockPanel.Dock="Top"
                                    Background="{DynamicResource BackgroundLight}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0 0 0 1"
                                    Padding="8 4">
                                <DockPanel>
                                    <!-- Formatting toolbar -->
                                    <StackPanel Orientation="Horizontal"
                                                VerticalAlignment="Center"
                                                DockPanel.Dock="Left"
                                                Margin="0 0 8 0">
                                        <!-- Bold -->
                                        <Button x:Name="BoldButton"
                                                Style="{StaticResource IconButton}"
                                                Width="24"
                                                Height="24"
                                                Margin="0 0 2 0"
                                                ToolTip="Bold (Ctrl+B)"
                                                Click="OnNotesFormatBold">
                                            <iconPacks:PackIconBootstrapIcons Kind="TypeBold"
                                                                              Width="10"
                                                                              Height="10" />
                                        </Button>

                                        <!-- Italic -->
                                        <Button x:Name="ItalicButton"
                                                Style="{StaticResource IconButton}"
                                                Width="24"
                                                Height="24"
                                                Margin="0 0 2 0"
                                                ToolTip="Italic (Ctrl+I)"
                                                Click="OnNotesFormatItalic">
                                            <iconPacks:PackIconBootstrapIcons Kind="TypeItalic"
                                                                              Width="10"
                                                                              Height="10" />
                                        </Button>

                                        <!-- Underline -->
                                        <Button x:Name="UnderlineButton"
                                                Style="{StaticResource IconButton}"
                                                Width="24"
                                                Height="24"
                                                Margin="0 0 8 0"
                                                ToolTip="Underline (Ctrl+U)"
                                                Click="OnNotesFormatUnderline">
                                            <iconPacks:PackIconBootstrapIcons Kind="TypeUnderline"
                                                                              Width="10"
                                                                              Height="10" />
                                        </Button>

                                        <!-- Bullet List -->
                                        <Button x:Name="BulletListButton"
                                                Style="{StaticResource IconButton}"
                                                Width="24"
                                                Height="24"
                                                Margin="0 0 2 0"
                                                ToolTip="Bullet List"
                                                Click="OnNotesFormatBulletList">
                                            <iconPacks:PackIconBootstrapIcons Kind="ListUl"
                                                                              Width="10"
                                                                              Height="10" />
                                        </Button>

                                        <!-- Numbered List -->
                                        <Button x:Name="NumberedListButton"
                                                Style="{StaticResource IconButton}"
                                                Width="24"
                                                Height="24"
                                                Margin="0 0 0 0"
                                                ToolTip="Numbered List"
                                                Click="OnNotesFormatNumberedList">
                                            <iconPacks:PackIconBootstrapIcons Kind="ListOl"
                                                                              Width="10"
                                                                              Height="10" />
                                        </Button>
                                    </StackPanel>

                                    <!-- Save status and button -->
                                    <StackPanel Orientation="Horizontal"
                                                DockPanel.Dock="Right"
                                                VerticalAlignment="Center">
                                        <TextBlock x:Name="NotesSaveStatusText"
                                                   Text="All changes saved"
                                                   FontSize="8"
                                                   Foreground="{DynamicResource TextSecondary}"
                                                   VerticalAlignment="Center"
                                                   Margin="0 0 4 0" />
                                        <Button Command="{Binding SaveNotesCommand}"
                                                Style="{StaticResource IconButton}"
                                                ToolTip="Save notes">
                                            <iconPacks:PackIconMaterial Kind="ContentSaveOutline"
                                                                        Width="12"
                                                                        Height="12" />
                                        </Button>
                                    </StackPanel>
                                </DockPanel>
                            </Border>

                            <!-- Rich text box fills remaining space with border -->
                            <Border Margin="4"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    Background="{DynamicResource SurfaceBackground}">
                                <RichTextBox x:Name="NotesRichTextBox"
                                             AcceptsReturn="True"
                                             VerticalScrollBarVisibility="Auto"
                                             BorderThickness="0"
                                             Background="{DynamicResource SurfaceBackground}"
                                             Loaded="OnNotesRichTextBoxLoaded"
                                             TextChanged="OnNotesTextChanged" />
                            </Border>
                        </DockPanel>
                    </TabItem>

                    <!-- Case Info Tab -->
                    <TabItem Header="Case Info">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <Grid Margin="12" HorizontalAlignment="Left">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="250" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="250" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- Case Number -->
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Case Number:"
                                           Style="{StaticResource LabelText}"
                                           VerticalAlignment="Center"
                                           Margin="0 0 8 0" />
                                <TextBox Grid.Row="0" Grid.Column="1"
                                         Text="{Binding CurrentCase.CaseNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         IsEnabled="{Binding CurrentCase, Converter={StaticResource BoolToVis}}"
                                         Margin="0 0 0 6" />

                                <!-- Court Location -->
                                <TextBlock Grid.Row="0" Grid.Column="3"
                                           Text="Court Location:"
                                           Style="{StaticResource LabelText}"
                                           VerticalAlignment="Center"
                                           Margin="0 0 8 0" />
                                <TextBox Grid.Row="0" Grid.Column="4"
                                         Text="{Binding CurrentCase.CaseLocation, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         IsEnabled="{Binding CurrentCase, Converter={StaticResource BoolToVis}}"
                                         Margin="0 0 0 6" />

                                <!-- Court Level -->
                                <TextBlock Grid.Row="1" Grid.Column="0"
                                           Text="Court Level:"
                                           Style="{StaticResource LabelText}"
                                           VerticalAlignment="Center"
                                           Margin="0 0 8 0" />
                                <TextBox Grid.Row="1" Grid.Column="1"
                                         Text="{Binding CurrentCase.CourtLevel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         IsEnabled="{Binding CurrentCase, Converter={StaticResource BoolToVis}}"
                                         Margin="0 0 0 6" />

                                <!-- Save Button -->
                                <Button Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                        Content="Save Case Info"
                                        Command="{Binding SaveCaseCommand}"
                                        HorizontalAlignment="Left"
                                        Margin="0 6 0 0" />
                            </Grid>
                        </ScrollViewer>
                    </TabItem>

                    <!-- Info Tab -->
                    <TabItem Header="Info">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="12">
                                <TextBlock Text="Case Statistics"
                                           Style="{StaticResource HeaderText}"
                                           Margin="0 0 0 8" />

                                <Grid Margin="0 8 0 0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!-- Total Evidence -->
                                    <TextBlock Grid.Row="0" Grid.Column="0"
                                               Text="Total Evidence:"
                                               Style="{StaticResource LabelText}"
                                               FontWeight="SemiBold"
                                               Margin="0 4" />
                                    <TextBlock Grid.Row="0" Grid.Column="1"
                                               Text="{Binding EvidenceSummaries.Count}"
                                               Style="{StaticResource BodyText}"
                                               Margin="8 4" />

                                    <!-- Case Created -->
                                    <TextBlock Grid.Row="1" Grid.Column="0"
                                               Text="Case Created:"
                                               Style="{StaticResource LabelText}"
                                               FontWeight="SemiBold"
                                               Margin="0 4" />
                                    <TextBlock Grid.Row="1" Grid.Column="1"
                                               Text="{Binding CurrentCase.CreatedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                               Style="{StaticResource BodyText}"
                                               Margin="8 4" />

                                    <!-- Last Opened -->
                                    <TextBlock Grid.Row="2" Grid.Column="0"
                                               Text="Last Opened:"
                                               Style="{StaticResource LabelText}"
                                               FontWeight="SemiBold"
                                               Margin="0 4" />
                                    <TextBlock Grid.Row="2" Grid.Column="1"
                                               Text="{Binding CurrentCase.LastOpenedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                               Style="{StaticResource BodyText}"
                                               Margin="8 4" />

                                    <!-- Case Path -->
                                    <TextBlock Grid.Row="3" Grid.Column="0"
                                               Text="Case Location:"
                                               Style="{StaticResource LabelText}"
                                               FontWeight="SemiBold"
                                               Margin="0 4"
                                               VerticalAlignment="Top" />
                                    <TextBlock Grid.Row="3" Grid.Column="1"
                                               Text="{Binding CurrentCase.RootPath}"
                                               Style="{StaticResource BodyText}"
                                               TextWrapping="Wrap"
                                               Margin="8 4" />
                                </Grid>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>
    </DockPanel>
</adonis:AdonisWindow>
